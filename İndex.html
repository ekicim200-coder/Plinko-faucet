<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Plinko: Adsgram Integration</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://adsgram.ai/js/adsgram.js?v=1"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@500;700;900&display=swap');
        body { margin: 0; overflow: hidden; background-color: #0b0e14; font-family: 'Roboto', sans-serif; color: white; touch-action: none; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* UI STYLES */
        #value-table { position: absolute; top: 10px; left: 10px; background: rgba(17, 24, 39, 0.95); border: 1px solid #374151; border-radius: 8px; padding: 8px; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.5); min-width: 150px; }
        #value-table h3 { margin: 0 0 5px 0; font-size: 10px; color: #9ca3af; text-transform: uppercase; text-align: center; border-bottom: 1px solid #374151; padding-bottom: 3px; }
        .val-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; font-size: 10px; color: #e5e7eb; }
        .coin-mini-icon { width: 14px; height: 14px; margin-right: 5px; border-radius: 50%; vertical-align: middle; }
        .coin-fixed-val { font-family: monospace; color: #60a5fa; font-weight: bold; font-size: 10px; }
        
        #session-score-panel { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.6); padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); pointer-events: none; display: flex; align-items: center; gap: 5px; opacity: 0; transition: opacity 0.3s; }
        #session-score-panel.visible { opacity: 1; }
        .session-lbl { font-size: 10px; color: #aaa; font-weight: bold; }
        .session-val { font-size: 12px; font-weight: bold; color: #4ade80; letter-spacing: 1px; }

        #wallet-btn-open { position: absolute; top: 10px; right: 10px; background: #10b981; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; z-index: 15; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4); font-size: 12px; display: flex; align-items: center; gap: 5px; }
        #wallet-btn-open:active { transform: scale(0.95); }

        #withdraw-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .withdraw-box { background: #1f2937; width: 100%; max-width: 400px; border-radius: 12px; border: 1px solid #374151; padding: 20px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .w-header { display: flex; justify-content: space-between; align-items: center; }
        .w-title { font-size: 18px; font-weight: bold; color: #fff; }
        .w-close { background: none; border: none; color: #9ca3af; font-size: 24px; cursor: pointer; }

        .coin-withdraw-row { background: #111827; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #374151; }
        .cw-top { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .cw-name { font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .cw-bal { font-family: monospace; color: #fbbf24; font-size: 12px; }
        .progress-track { width: 100%; height: 8px; background: #374151; border-radius: 4px; margin: 8px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #10b981; width: 0%; transition: width 0.5s; }
        .cw-info { display: flex; justify-content: space-between; font-size: 10px; color: #6b7280; margin-bottom: 10px; }
        .wallet-input { width: 100%; background: #0b0e14; border: 1px solid #374151; color: white; padding: 8px; border-radius: 4px; font-size: 12px; margin-bottom: 5px; box-sizing: border-box; }
        .w-btn { width: 100%; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; background: #374151; color: #9ca3af; transition: 0.2s; }
        .w-btn.active { background: #10b981; color: white; box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3); }
        .w-btn.active:active { transform: scale(0.98); }

        .history-container { border-top: 1px solid #374151; padding-top: 10px; margin-top: 10px; }
        .history-title { font-size: 12px; color: #9ca3af; font-weight: bold; margin-bottom: 10px; letter-spacing: 1px; }
        #history-list { max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .h-row { display: flex; justify-content: space-between; align-items: center; background: #111827; padding: 8px; border-radius: 6px; font-size: 11px; border: 1px solid #374151; }
        .h-left { display: flex; flex-direction: column; gap: 2px; }
        .h-coin { color: #fff; font-weight: bold; }
        .h-date { color: #6b7280; font-size: 9px; }
        .h-amount { color: #fbbf24; font-family: monospace; font-weight: bold; }
        .h-status { padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 9px; }
        .st-pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.4); }
        .st-sent { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.4); }

        #modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 90; }
        .modal-box { background: #1f2937; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #374151; width: 85%; max-width: 320px; }
        
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #374151; font-size: 13px; color: #e5e7eb; }
        .summary-row:last-child { border-bottom: none; }
        .sum-val { font-family: monospace; color: #4ade80; font-weight: bold; }
        
        #ui-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 110px; background: #111827; border-top: 2px solid #1f2937; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 20; }
        .stat-group { display: flex; flex-direction: column; }
        .stat-title { font-size: 10px; color: #6b7280; font-weight: bold; }
        .stat-num { font-size: 24px; color: #34d399; font-weight: 900; font-family: monospace; }
        #drop-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; width: 100px; height: 50px; font-size: 18px; font-weight: 900; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 0 #1d4ed8; }
        #drop-btn:active { transform: translateY(4px); box-shadow: none; }
        #drop-btn:disabled { background: #374151; color: #6b7280; box-shadow: none; }
    </style>
</head>
<body>

    <div id="value-table">
        <h3>BALL VALUES</h3>
        <div class="val-row"><div style="display:flex; align-items:center;"><img src="" id="icon-btc" class="coin-mini-icon">BTC</div> <span class="coin-fixed-val">0.00000001</span></div>
        <div class="val-row"><div style="display:flex; align-items:center;"><img src="" id="icon-eth" class="coin-mini-icon">ETH</div> <span class="coin-fixed-val">0.0000006</span></div>
        <div class="val-row"><div style="display:flex; align-items:center;"><img src="" id="icon-trx" class="coin-mini-icon">TRX</div> <span class="coin-fixed-val">0.001</span></div>
        <div class="val-row"><div style="display:flex; align-items:center;"><img src="" id="icon-usdt" class="coin-mini-icon">USDT</div> <span class="coin-fixed-val">0.002</span></div>
        <div class="val-row"><div style="display:flex; align-items:center;"><img src="" id="icon-str" class="coin-mini-icon">STR</div> <span class="coin-fixed-val">5.000</span></div>
    </div>

    <div id="session-score-panel">
        <span class="session-lbl">SESSION:</span>
        <span class="session-val">ACTIVE</span>
    </div>

    <button id="wallet-btn-open" onclick="window.game.openWithdrawModal()">üí∞ WALLET & WITHDRAW</button>

    <div id="withdraw-modal">
        <div class="withdraw-box">
            <div class="w-header">
                <span class="w-title">WALLET</span>
                <button class="w-close" onclick="window.game.closeWithdrawModal()">&times;</button>
            </div>
            <div id="withdraw-list"></div>
            <div class="history-container">
                <div class="history-title">TRANSACTION HISTORY</div>
                <div id="history-list"><div style="text-align:center; color:#555; padding:10px;">Loading history...</div></div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="modal-overlay">
        <div class="modal-box">
            <h2 style="color:#fff; margin-top:0;">SESSION COMPLETE</h2>
            <p style="color:#9ca3af; font-size:12px; margin-bottom:15px;">Your earnings this round:</p>
            <div id="round-summary" style="margin-bottom:20px; background:#111827; padding:10px; border-radius:8px;"></div>
            <button onclick="window.game.triggerAd()" style="background:#10b981; color:white; border:none; padding:12px; width:100%; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px; box-shadow: 0 4px 0 #059669;">
                üì∫ WATCH AD & CLAIM
            </button>
        </div>
    </div>

    <div id="ui-bar">
        <button onclick="window.game.triggerAd()" style="background:#10b981; color:white; border:none; padding:10px; border-radius:5px; font-weight:bold; font-size:12px; box-shadow: 0 3px 0 #059669; transition:0.1s;">CLAIM<br>BALLS</button>
        <div class="stat-group">
            <span class="stat-title">BALLS LEFT</span>
            <span class="stat-num" id="balls-left">10</span>
        </div>
        <button id="drop-btn" disabled>LOADING...</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // 1. FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCEfbxvL_RyxzRHC6O6SDSMQ_mHezIFCDw",
            authDomain: "plinko-faucet.firebaseapp.com",
            projectId: "plinko-faucet",
            storageBucket: "plinko-faucet.firebasestorage.app",
            messagingSenderId: "945891210512",
            appId: "1:945891210512:web:eb66f91746bd8c8c032195",
        };

        // 2. ADSGRAM BLOCK ID (G√ºncellendi)
        const AdsgramBlockId = "21046"; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const userId = tg.initDataUnsafe?.user?.id ? tg.initDataUnsafe.user.id.toString() : "test_user_mobile";
        const username = tg.initDataUnsafe?.user?.first_name || "Unknown";

        // --- GAME VARIABLES ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const COINS = [
            { id: 'btc',  baseVal: 0.00000001, currentBalance: 0, minWithdraw: 0.0001, src: 'https://cryptologos.cc/logos/bitcoin-btc-logo.png?v=025', color: '#f7931a', decimals: 8 },
            { id: 'eth',  baseVal: 0.0000006,  currentBalance: 0, minWithdraw: 0.001,   src: 'https://cryptologos.cc/logos/ethereum-eth-logo.png?v=025', color: '#627eea', decimals: 7 },
            { id: 'trx',  baseVal: 0.001,      currentBalance: 0, minWithdraw: 50,      src: 'https://cryptologos.cc/logos/tron-trx-logo.png?v=025', color: '#ef0027', decimals: 3 },
            { id: 'usdt', baseVal: 0.002,      currentBalance: 0, minWithdraw: 10,      src: 'https://cryptologos.cc/logos/tether-usdt-logo.png?v=025', color: '#26a17b', decimals: 3 },
            { id: 'str',  baseVal: 5.0,        currentBalance: 0, minWithdraw: 20000,   src: 'https://cdn-icons-png.flaticon.com/512/616/616490.png', color: '#ffffff', decimals: 2 }
        ];

        const ROWS = 14; const GRAVITY = 0.55; const FRICTION = 0.98; const BOUNCE = 0.55; const UI_HEIGHT = 110; 
        const MULTIPLIERS = [10, 5, 2, 1, 0.5, 0.2, 0.2, 0.2, 0.5, 1, 2, 5, 10];

        let width, height;
        let ballQueue = []; let pegs = []; let balls = []; let slots = []; let particles = []; let popups = [];
        let lastDropTime = 0;
        let sessionGains = {};

        // UI Refs
        const ballsLeftEl = document.getElementById('balls-left');
        const dropBtn = document.getElementById('drop-btn');
        const modal = document.getElementById('modal-overlay');
        const roundSummaryEl = document.getElementById('round-summary');
        const withdrawModal = document.getElementById('withdraw-modal');
        const withdrawList = document.getElementById('withdraw-list');
        const sessionPanel = document.getElementById('session-score-panel');
        const historyList = document.getElementById('history-list');

        // --- FIREBASE LOGIC ---
        async function loadUserData() {
            try {
                const userRef = doc(db, "users", userId);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    COINS.forEach(c => {
                        if (data.balances && data.balances[c.id] !== undefined) {
                            c.currentBalance = parseFloat(data.balances[c.id]);
                        }
                    });
                } else {
                    const initialBalances = {};
                    COINS.forEach(c => initialBalances[c.id] = 0);
                    await setDoc(userRef, { username: username, createdAt: serverTimestamp(), balances: initialBalances });
                }
            } catch (e) { console.error("Error loading data: ", e); }
        }

        async function saveUserData() {
            try {
                const balancesToSave = {};
                COINS.forEach(c => balancesToSave[c.id] = c.currentBalance);
                const userRef = doc(db, "users", userId);
                await updateDoc(userRef, { balances: balancesToSave, lastActive: serverTimestamp() });
            } catch (e) { console.error("Error saving data: ", e); }
        }

        async function createWithdrawRequest(coinId, amount, address) {
            try {
                await addDoc(collection(db, "withdrawals"), {
                    userId: userId,
                    username: username,
                    coin: coinId,
                    amount: amount,
                    address: address,
                    status: 0, 
                    createdAt: serverTimestamp()
                });
                return true;
            } catch (e) { console.error("Error creating withdrawal: ", e); return false; }
        }

        function subscribeToHistory() {
            const q = query(collection(db, "withdrawals"), where("userId", "==", userId));
            onSnapshot(q, (snapshot) => {
                const historyEl = document.getElementById('history-list');
                const withdrawals = [];
                snapshot.forEach((doc) => { withdrawals.push({ id: doc.id, ...doc.data() }); });
                withdrawals.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                if (withdrawals.length === 0) { historyEl.innerHTML = '<div style="text-align:center; color:#555; padding:10px;">No transactions yet.</div>'; return; }

                historyEl.innerHTML = "";
                withdrawals.forEach(w => {
                    const isSent = (w.status == 1 || w.status == "1");
                    const statusClass = isSent ? 'st-sent' : 'st-pending';
                    const statusText = isSent ? '‚úÖ SENT' : '‚è≥ PENDING';
                    const dateObj = w.createdAt ? new Date(w.createdAt.seconds * 1000) : new Date();
                    const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                    const div = document.createElement('div');
                    div.className = 'h-row';
                    div.innerHTML = `
                        <div class="h-left"><span class="h-coin">${w.coin.toUpperCase()}</span><span class="h-date">${dateStr}</span></div>
                        <div style="text-align:right;"><div class="h-amount">${parseFloat(w.amount).toFixed(8)}</div><span class="h-status ${statusClass}">${statusText}</span></div>
                    `;
                    historyEl.appendChild(div);
                });
            });
        }

        // --- ADSGRAM & GAME LOGIC ---
        window.game = {
            openWithdrawModal: () => { renderWithdrawList(); subscribeToHistory(); withdrawModal.style.display = 'flex'; },
            closeWithdrawModal: () => { withdrawModal.style.display = 'none'; },
            
            requestWithdraw: async (coinId) => {
                const coin = COINS.find(c => c.id === coinId);
                const addrInput = document.getElementById(`addr-${coinId}`);
                const address = addrInput.value.trim();
                if (address.length < 5) return alert("Please enter a valid wallet address!");
                if (confirm(`Withdraw ${coin.currentBalance.toFixed(coin.decimals)} ${coin.id.toUpperCase()}?`)) {
                    const amount = coin.currentBalance;
                    coin.currentBalance = 0;
                    await saveUserData(); 
                    const success = await createWithdrawRequest(coin.id, amount, address);
                    if(success) { alert("‚úÖ Request Sent!"); renderWithdrawList(); } else { alert("‚ùå Error."); coin.currentBalance = amount; saveUserData(); }
                }
            },

            // --- ADSGRAM REKLAM FONKSƒ∞YONU ---
            triggerAd: () => {
                // Adsgram Controller
                if (window.Adsgram) {
                    const AdController = window.Adsgram.init({ blockId: AdsgramBlockId });
                    AdController.show().then((result) => {
                        // Reklam ba≈üarƒ±yla izlendi (reward)
                        window.game.claimReward();
                    }).catch((result) => {
                        // Hata veya ge√ßme (skip)
                        console.log("Adsgram error/skip:", result);
                        // Kullanƒ±cƒ± reklamƒ± atlarsa veya hata olursa yine de √∂d√ºl√º veriyoruz (Kullanƒ±cƒ± deneyimi i√ßin)
                        window.game.claimReward(); 
                    });
                } else {
                    console.error("Adsgram script not loaded!");
                    window.game.claimReward(); // Fallback
                }
            },

            claimReward: () => {
                let hasGain = false;
                COINS.forEach(c => { if(sessionGains[c.id]) { c.currentBalance += sessionGains[c.id]; hasGain = true; } });
                if(hasGain) saveUserData();
                modal.style.display = 'none';
                refillBalls();
            }
        };

        // --- HELPERS ---
        function renderWithdrawList() {
            withdrawList.innerHTML = '';
            COINS.forEach(coin => {
                const progress = Math.min((coin.currentBalance / coin.minWithdraw) * 100, 100);
                const isReady = coin.currentBalance >= coin.minWithdraw;
                const div = document.createElement('div');
                div.className = 'coin-withdraw-row';
                div.innerHTML = `
                    <div class="cw-top"><div class="cw-name"><img src="${coin.src}" width="16"> ${coin.id.toUpperCase()}</div><div class="cw-bal">${coin.currentBalance.toFixed(coin.decimals)}</div></div>
                    <div class="progress-track"><div class="progress-bar" style="width: ${progress}%"></div></div>
                    <div class="cw-info"><span>Min: ${coin.minWithdraw}</span><span>${progress.toFixed(1)}%</span></div>
                    <input type="text" class="wallet-input" id="addr-${coin.id}" placeholder="${isReady ? 'Enter Wallet Address' : 'Limit Not Reached'}" ${isReady ? '' : 'disabled'}>
                    <button class="w-btn ${isReady ? 'active' : ''}" onclick="window.game.requestWithdraw('${coin.id}')" ${isReady ? '' : 'disabled'}>${isReady ? 'WITHDRAW' : 'INSUFFICIENT BALANCE'}</button>
                `;
                withdrawList.appendChild(div);
            });
        }

        let loadedCount = 0;
        function preload() {
            loadUserData().then(() => {
                COINS.forEach(c => {
                    const img = new Image(); img.src = c.src;
                    img.onload = () => { c.img = img; document.getElementById('icon-' + c.id).src = c.src; loadedCount++; if (loadedCount === COINS.length) { dropBtn.innerText = "DROP"; init(); } };
                });
            });
        }

        function init() { resize(); window.addEventListener('resize', resize); dropBtn.addEventListener('mousedown', tryDropBall); dropBtn.addEventListener('touchstart', (e) => { e.preventDefault(); tryDropBall(); }); refillBalls(); loop(); }
        function refillBalls() { ballQueue = []; sessionGains = { btc:0, eth:0, trx:0, usdt:0, str:0 }; COINS.forEach(c => { ballQueue.push(c); ballQueue.push(c); }); ballQueue.sort(() => Math.random() - 0.5); ballsLeftEl.innerText = ballQueue.length; dropBtn.disabled = false; modal.style.display = 'none'; sessionPanel.classList.remove('visible'); }
        function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; createBoard(); }
        function createBoard() { pegs = []; slots = []; const playableHeight = height - UI_HEIGHT; let spacingV = (playableHeight * 0.82) / (ROWS + 2); let spacingH = (width * 0.92) / (ROWS + 1); const spacing = Math.min(spacingV, spacingH); const pegRadius = spacing * 0.11; window.ballR = spacing * 0.22; const startY = playableHeight * 0.18; for (let row = 2; row < ROWS; row++) { for (let col = 0; col <= row; col++) { const x = (width / 2) - (row * spacing / 2) + (col * spacing); const y = startY + row * spacing; pegs.push({ x, y, r: pegRadius, pulse: 0 }); } } const slotY = startY + (ROWS - 1) * spacing; const startX = (width / 2) - ((ROWS) * spacing / 2); const slotW = spacing - 4; const slotH = playableHeight - slotY; for (let i = 0; i < ROWS + 1; i++) { const x = startX + i * spacing - (spacing/2); let mIndex = Math.floor((i / (ROWS + 1)) * MULTIPLIERS.length); let val = MULTIPLIERS[mIndex] || 0.2; slots.push({ x: x, y: slotY, w: slotW, h: slotH, val: val, color: val >= 5 ? '#ef4444' : (val >= 1 ? '#8b5cf6' : '#1f2937'), active: 0 }); } }
        function tryDropBall() { const now = Date.now(); if (now - lastDropTime < 400) return; lastDropTime = now; if (ballQueue.length === 0) return; const coin = ballQueue.pop(); ballsLeftEl.innerText = ballQueue.length; sessionPanel.classList.add('visible'); balls.push({ x: width / 2 + (Math.random()-0.5)*4, y: 70, vx: (Math.random()-0.5)*1, vy: 0, r: window.ballR, coin: coin, dead: false, stuckTimer: 0 }); if (ballQueue.length === 0) dropBtn.disabled = true; }
        function update() { let activeCount = 0; for (let b of balls) { if (!b.dead) activeCount++; b.vy += GRAVITY; b.vx *= FRICTION; b.x += b.vx; b.y += b.vy; if (Math.abs(b.vx) < 0.1 && Math.abs(b.vy) < 0.1) { b.stuckTimer++; if (b.stuckTimer > 10) { b.vy += 2; b.vx += (Math.random()-0.5)*2; b.stuckTimer = 0; } } else b.stuckTimer = 0; for (let p of pegs) { let dx = b.x - p.x; let dy = b.y - p.y; let dist = Math.hypot(dx, dy); if (dist < p.r + b.r) { let angle = Math.atan2(dy, dx); let speed = Math.hypot(b.vx, b.vy) * BOUNCE; if (speed<1.2) speed=1.2; b.vx = Math.cos(angle)*speed + (Math.random()-0.5)*0.2; b.vy = Math.sin(angle)*speed; let overlap = (p.r + b.r) - dist; b.x += Math.cos(angle)*overlap; b.y += Math.sin(angle)*overlap; p.pulse = 5; } } if (slots.length > 0 && b.y > slots[0].y) { for (let s of slots) { if (b.x > s.x && b.x < s.x + s.w) { finishBall(b, s); break; } } if (b.y > height) b.dead = true; } } if (particles.length > 80) particles.splice(0, particles.length - 80); if (ballQueue.length === 0 && activeCount === 0 && balls.length > 0) setTimeout(showSummary, 800); balls = balls.filter(b => !b.dead); pegs.forEach(p => { if (p.pulse > 0) p.pulse--; }); slots.forEach(s => { if (s.active > 0) s.active--; }); for(let i=popups.length-1; i>=0; i--) { popups[i].y -= 1; popups[i].life -= 0.02; if(popups[i].life <= 0) popups.splice(i, 1); } for(let i=particles.length-1; i>=0; i--) { particles[i].x += particles[i].vx; particles[i].y += particles[i].vy; particles[i].life -= 0.05; if(particles[i].life <= 0) particles.splice(i, 1); } }
        function finishBall(b, s) { b.dead = true; const earned = b.coin.baseVal * s.val; if(sessionGains[b.coin.id] === undefined) sessionGains[b.coin.id] = 0; sessionGains[b.coin.id] += earned; s.active = 10; popups.push({ txt: `+${earned.toFixed(b.coin.decimals)}`, x: b.x, y: b.y - 20, color: b.coin.color, life: 1.0 }); for(let i=0; i<5; i++) particles.push({ x: b.x, y: b.y, vx: (Math.random()-0.5)*6, vy: (Math.random()-0.5)*6, color: b.coin.color, life: 1.0 }); }
        function showSummary() { let html = ''; COINS.forEach(c => { const gain = sessionGains[c.id] || 0; if(gain > 0) { html += `<div class="summary-row"><span style="display:flex; align-items:center"><img src="${c.src}" width="14" style="margin-right:5px">${c.id.toUpperCase()}</span><span class="sum-val">+${gain.toFixed(c.decimals)}</span></div>`; } }); roundSummaryEl.innerHTML = html || '<div style="color:#666; text-align:center;">No Earnings</div>'; modal.style.display = 'flex'; }
        function draw() { ctx.fillStyle = '#0b0e14'; ctx.fillRect(0, 0, width, height); for (let s of slots) { ctx.fillStyle = s.active > 0 ? '#fff' : s.color; ctx.globalAlpha = 0.2; ctx.fillRect(s.x, s.y, s.w, s.h); ctx.globalAlpha = 1; ctx.fillStyle = s.color; ctx.fillRect(s.x, s.y, s.w, 4); ctx.fillStyle = '#fff'; ctx.font = 'bold 10px Roboto'; ctx.textAlign = 'center'; ctx.fillText(s.val + 'x', s.x + s.w/2, s.y + 20); } for (let p of pegs) { ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fillStyle = p.pulse > 0 ? '#fff' : '#334155'; ctx.fill(); } for (let b of balls) { ctx.save(); ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.closePath(); ctx.clip(); ctx.drawImage(b.coin.img, b.x - b.r, b.y - b.r, b.r*2, b.r*2); ctx.restore(); } for(let p of particles) { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4); ctx.globalAlpha = 1; } for(let p of popups) { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.font = 'bold 12px monospace'; ctx.textAlign='center'; ctx.fillText(p.txt, p.x, p.y); ctx.globalAlpha = 1; } }
        function loop() { update(); draw(); requestAnimationFrame(loop); }
        preload();
    </script>
</body>
</html>
