<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Plinko: Final</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@500;700;900&display=swap');
        body { margin: 0; overflow: hidden; background-color: #0b0e14; font-family: 'Roboto', sans-serif; color: white; touch-action: none; }
        
        /* OYUN ALANI */
        canvas { display: block; width: 100%; height: calc(100vh - 160px); } 
        
        /* UI STYLES */
        #value-table { position: absolute; top: 10px; left: 10px; background: rgba(17, 24, 39, 0.95); border: 1px solid #374151; border-radius: 8px; padding: 8px; z-index: 10; min-width: 140px; }
        .val-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; font-size: 10px; color: #e5e7eb; }
        .coin-mini-icon { width: 14px; height: 14px; margin-right: 5px; border-radius: 50%; vertical-align: middle; }
        .coin-fixed-val { font-family: monospace; color: #60a5fa; font-weight: bold; font-size: 10px; }
        
        #session-score-panel { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.6); padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); pointer-events: none; display: flex; align-items: center; gap: 5px; opacity: 0; transition: opacity 0.3s; }
        #session-score-panel.visible { opacity: 1; }
        .session-lbl { font-size: 10px; color: #aaa; font-weight: bold; }
        .session-val { font-size: 12px; font-weight: bold; color: #4ade80; letter-spacing: 1px; }

        #wallet-btn-open { position: absolute; top: 10px; right: 10px; background: #10b981; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; z-index: 15; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4); font-size: 12px; display: flex; align-items: center; gap: 5px; }
        #wallet-btn-open:active { transform: scale(0.95); }

        /* BANNER ALANI (ID: 21121) */
        #banner-area {
            position: absolute;
            bottom: 110px;
            left: 0;
            width: 100%;
            height: 50px;
            background: linear-gradient(90deg, #1f2937, #111827);
            border-top: 1px solid #374151;
            border-bottom: 1px solid #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 18;
            cursor: pointer;
            overflow: hidden;
        }
        .banner-content {
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulseBanner 2s infinite;
        }
        .banner-icon { font-size: 20px; }
        .banner-text { 
            color: #fbbf24; 
            font-size: 12px; 
            font-weight: 900; 
            letter-spacing: 1px; 
            text-transform: uppercase;
        }
        @keyframes pulseBanner { 0% { opacity: 0.8; transform: scale(0.98); } 50% { opacity: 1; transform: scale(1); } 100% { opacity: 0.8; transform: scale(0.98); } }

        /* UI BAR */
        #ui-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 110px; background: #0b0e14; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 20; border-top: 1px solid #1f2937; }
        
        .left-controls { display: flex; flex-direction: column; gap: 8px; align-items: flex-start; }
        
        /* 50x BUTONU (ID: 21122) */
        .btn-50x {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 900;
            font-size: 11px;
            box-shadow: 0 3px 0 #92400e;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-50x:active { transform: translateY(2px); box-shadow: 0 1px 0 #92400e; }

        /* CLAIM BUTONU (30s TIMER) */
        .btn-claim {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 11px;
            box-shadow: 0 3px 0 #1d4ed8;
            cursor: pointer;
            text-align: center;
            line-height: 1.2;
            min-width: 80px;
            transition: 0.3s;
        }
        .btn-claim:active { transform: translateY(2px); box-shadow: 0 1px 0 #1d4ed8; }
        .btn-claim:disabled { background: #374151; color: #9ca3af; box-shadow: none; cursor: not-allowed; transform: none; }

        .stat-group { display: flex; flex-direction: column; align-items: center; }
        .stat-title { font-size: 10px; color: #6b7280; font-weight: bold; }
        .stat-num { font-size: 24px; color: #34d399; font-weight: 900; font-family: monospace; }
        
        #drop-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; width: 100px; height: 50px; font-size: 18px; font-weight: 900; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 0 #1d4ed8; }
        #drop-btn:active { transform: translateY(4px); box-shadow: none; }
        #drop-btn:disabled { background: #374151; color: #6b7280; box-shadow: none; }

        /* MODALS */
        #modal-overlay, #withdraw-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .modal-box { background: #1f2937; padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; text-align: center; border: 1px solid #374151; }
        
        .withdraw-box { background: #1f2937; width: 90%; max-width: 400px; border-radius: 12px; border: 1px solid #374151; padding: 20px; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .w-header { display: flex; justify-content: space-between; align-items: center; }
        .coin-withdraw-row { background: #111827; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #374151; }
        .cw-top { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .cw-name { font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .cw-bal { font-family: monospace; color: #fbbf24; font-size: 12px; }
        .progress-track { width: 100%; height: 8px; background: #374151; border-radius: 4px; margin: 8px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #10b981; width: 0%; transition: width 0.5s; }
        .wallet-input { width: 100%; background: #0b0e14; border: 1px solid #374151; color: white; padding: 8px; border-radius: 4px; font-size: 12px; margin-bottom: 5px; box-sizing: border-box; }
        .w-btn { width: 100%; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; background: #374151; color: #9ca3af; transition: 0.2s; }
        .w-btn.active { background: #10b981; color: white; box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3); }

        .history-container { border-top: 1px solid #374151; padding-top: 10px; margin-top: 10px; }
        .h-row { display: flex; justify-content: space-between; align-items: center; background: #111827; padding: 8px; border-radius: 6px; font-size: 11px; border: 1px solid #374151; margin-bottom: 5px; }
        .st-pending { color: #f59e0b; } .st-sent { color: #10b981; }
    </style>
</head>
<body>

    <div id="value-table">
        <h3>BALL VALUES</h3>
        <div class="val-row"><div style="display:flex; align-items:center;"><img src="" id="icon-btc" class="coin-mini-icon">BTC</div> <span class="coin-fixed-val">0.00000005</span></div>
        <div class="val-row"><div style="display:flex; align-items:center;"><img src="" id="icon-eth" class="coin-mini-icon">ETH</div> <span class="coin-fixed-val">0.0000003</span></div>
        <div class="val-row"><div style="display:flex; align-items:center;"><img src="" id="icon-trx" class="coin-mini-icon">TRX</div> <span class="coin-fixed-val">0.007</span></div>
        <div class="val-row"><div style="display:flex; align-items:center;"><img src="" id="icon-usdt" class="coin-mini-icon">USDT</div> <span class="coin-fixed-val">0.002</span></div>
        <div class="val-row"><div style="display:flex; align-items:center;"><img src="" id="icon-str" class="coin-mini-icon">STR</div> <span class="coin-fixed-val">2.000</span></div>
    </div>

    <div id="session-score-panel">
        <span class="session-lbl">SESSION:</span>
        <span class="session-val">ACTIVE</span>
    </div>

    <button id="wallet-btn-open" onclick="window.game.openWithdrawModal()">üí∞ WALLET</button>

    <div id="withdraw-modal">
        <div class="withdraw-box">
            <div class="w-header">
                <span class="w-title">WALLET</span>
                <button class="w-close" onclick="window.game.closeWithdrawModal()" style="background:none; border:none; color:#999; font-size:20px;">&times;</button>
            </div>
            <div style="font-size:10px; color:#4ade80; text-align:center; margin-bottom:10px;">‚òÖ Balances Synced ‚òÖ</div>
            <div id="withdraw-list"></div>
            <div class="history-container">
                <div style="font-size:10px; color:#aaa; margin-bottom:5px;">HISTORY</div>
                <div id="history-list"></div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="banner-area" onclick="window.game.showBannerAd()">
        <div class="banner-content">
            <span class="banner-icon">üöÄ</span>
            <span class="banner-text">CLICK FOR SPONSOR TASKS</span>
            <span class="banner-icon">‚≠ê</span>
        </div>
    </div>

    <div id="ui-bar">
        <div class="left-controls">
            <button class="btn-50x" onclick="window.game.trigger50xAd()">
                üéÅ 50x BALLS
            </button>
            <button id="btn-free" class="btn-claim" onclick="window.game.claimFreeBalls()">
                FREE<br>5 BALLS
            </button>
        </div>

        <div class="stat-group">
            <span class="stat-title">BALLS LEFT</span>
            <span class="stat-num" id="balls-left">10</span>
        </div>
        
        <button id="drop-btn" disabled>LOADING...</button>
    </div>

    <div id="modal-overlay">
        <div class="modal-box">
            <h2 style="color:#fff; margin-top:0;">SESSION COMPLETE</h2>
            <div id="round-summary" style="margin-bottom:20px; background:#111827; padding:10px; border-radius:8px;"></div>
            
            <button class="btn-50x" onclick="window.game.trigger50xAd()" style="width:100%; justify-content:center; padding:12px; margin-bottom:10px;">
                 üì∫ GET 50 BALLS (AD)
            </button>
            
            <p style="font-size:10px; color:#666;">or wait for free balls...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEfbxvL_RyxzRHC6O6SDSMQ_mHezIFCDw",
            authDomain: "plinko-faucet.firebaseapp.com",
            projectId: "plinko-faucet",
            storageBucket: "plinko-faucet.firebasestorage.app",
            messagingSenderId: "945891210512",
            appId: "1:945891210512:web:eb66f91746bd8c8c032195",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const userId = tg.initDataUnsafe?.user?.id ? tg.initDataUnsafe.user.id.toString() : "test_user_mobile";
        const username = tg.initDataUnsafe?.user?.first_name || "Unknown";

        // --- ADSGRAM ENTEGRASYONU ---
        // 1. √ñd√ºll√º Reklam (Reward Video) - YENƒ∞ ID: 21122
        const RewardController = window.Adsgram.init({ blockId: "21122" });

        // 2. Banner/Task Reklamƒ± - ID: 21121
        const BannerController = window.Adsgram.init({ blockId: "21121" });

        // --- GAME LOGIC ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const COINS = [
            { id: 'btc',  baseVal: 0.00000005, currentBalance: 0, minWithdraw: 0.0001, src: 'https://cryptologos.cc/logos/bitcoin-btc-logo.png?v=025', color: '#f7931a', decimals: 8 },
            { id: 'eth',  baseVal: 0.0000003,  currentBalance: 0, minWithdraw: 0.006,   src: 'https://cryptologos.cc/logos/ethereum-eth-logo.png?v=025', color: '#627eea', decimals: 7 },
            { id: 'trx',  baseVal: 0.007,      currentBalance: 0, minWithdraw: 70,      src: 'https://cryptologos.cc/logos/tron-trx-logo.png?v=025', color: '#ef0027', decimals: 3 },
            { id: 'usdt', baseVal: 0.002,      currentBalance: 0, minWithdraw: 50,      src: 'https://cryptologos.cc/logos/tether-usdt-logo.png?v=025', color: '#26a17b', decimals: 3 },
            { id: 'str',  baseVal: 2.0,        currentBalance: 0, minWithdraw: 50000,   src: 'https://cdn-icons-png.flaticon.com/512/616/616490.png', color: '#ffffff', decimals: 2 }
        ];

        const ROWS = 9; const GRAVITY = 0.55; const FRICTION = 0.98; const BOUNCE = 0.55;
        const MULTIPLIERS = [100, 25, 10, 5, 2, 2, 2, 10, 25, 100,];

        let width, height;
        let ballQueue = []; let pegs = []; let balls = []; let slots = []; let particles = []; let popups = [];
        let lastDropTime = 0;
        let sessionGains = {};
        let nextFreeClaimTime = 0;

        const ballsLeftEl = document.getElementById('balls-left');
        const dropBtn = document.getElementById('drop-btn');
        const modal = document.getElementById('modal-overlay');
        const roundSummaryEl = document.getElementById('round-summary');
        const sessionPanel = document.getElementById('session-score-panel');
        const withdrawModal = document.getElementById('withdraw-modal');
        const withdrawList = document.getElementById('withdraw-list');
        const historyList = document.getElementById('history-list');
        const btnFree = document.getElementById('btn-free');

        // --- FIREBASE OPS ---
        async function loadUserData() {
            try {
                const userRef = doc(db, "users", userId);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    COINS.forEach(c => { if (data.balances && data.balances[c.id] !== undefined) c.currentBalance = parseFloat(data.balances[c.id]); });
                } else {
                    const initialBalances = {}; COINS.forEach(c => initialBalances[c.id] = 0);
                    await setDoc(userRef, { username: username, createdAt: serverTimestamp(), balances: initialBalances });
                }
            } catch (e) { console.error(e); }
        }

        async function saveUserData() {
            try {
                const balancesToSave = {}; COINS.forEach(c => balancesToSave[c.id] = c.currentBalance);
                await updateDoc(doc(db, "users", userId), { balances: balancesToSave, lastActive: serverTimestamp() });
            } catch (e) { console.error(e); }
        }
        
        async function createWithdrawRequest(coinId, amount, address) {
            try {
                await addDoc(collection(db, "withdrawals"), { userId: userId, username: username, coin: coinId, amount: amount, address: address, status: 0, createdAt: serverTimestamp() });
                return true;
            } catch (e) { return false; }
        }

        function subscribeToHistory() {
            const q = query(collection(db, "withdrawals"), where("userId", "==", userId));
            onSnapshot(q, (snapshot) => {
                const withdrawals = [];
                snapshot.forEach((doc) => { withdrawals.push({ id: doc.id, ...doc.data() }); });
                withdrawals.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                historyList.innerHTML = withdrawals.length ? '' : '<div style="text-align:center;color:#666;">No history</div>';
                withdrawals.forEach(w => {
                    const isSent = (w.status == 1);
                    historyList.innerHTML += `
                        <div class="h-row">
                            <div><span style="color:#fff;font-weight:bold">${w.coin.toUpperCase()}</span> <span style="font-size:9px;color:#666">${new Date(w.createdAt?.seconds*1000).toLocaleDateString()}</span></div>
                            <div style="text-align:right"><div style="color:#fbbf24;font-family:monospace">${parseFloat(w.amount).toFixed(8)}</div><span class="${isSent?'st-sent':'st-pending'}">${isSent?'SENT':'PENDING'}</span></div>
                        </div>`;
                });
            });
        }

        function checkTimer() {
            const now = Date.now();
            const diff = nextFreeClaimTime - now;
            if (diff > 0) {
                const sec = Math.ceil(diff / 1000);
                btnFree.disabled = true;
                btnFree.innerHTML = `WAIT<br>${sec}s`;
            } else {
                btnFree.disabled = false;
                btnFree.innerHTML = `FREE<br>5 BALLS`;
            }
        }
        setInterval(checkTimer, 1000);

        // --- GAME & ADS CONTROL ---
        window.game = {
            openWithdrawModal: async () => {
                await saveUserData();
                renderWithdrawList();
                subscribeToHistory();
                withdrawModal.style.display = 'flex';
            },
            closeWithdrawModal: () => { withdrawModal.style.display = 'none'; },
            
            requestWithdraw: async (coinId) => {
                const coin = COINS.find(c => c.id === coinId);
                const addr = document.getElementById(`addr-${coinId}`).value.trim();
                if(addr.length < 5) return alert("Invalid address");
                if(confirm(`Withdraw ${coin.currentBalance} ${coin.id}?`)) {
                    await saveUserData();
                    const amt = coin.currentBalance; coin.currentBalance = 0; 
                    await saveUserData();
                    const ok = await createWithdrawRequest(coin.id, amt, addr);
                    if(ok) { alert("Sent!"); renderWithdrawList(); } else { coin.currentBalance = amt; saveUserData(); alert("Error"); }
                }
            },

            claimFreeBalls: () => {
                const now = Date.now();
                if (now < nextFreeClaimTime) return;
                nextFreeClaimTime = now + 30000;
                localStorage.setItem('nextFreeClaim', nextFreeClaimTime);
                checkTimer();
                applySessionGains(); 
                refillBalls(5);      
            },

            // REKLAMLI 50x CLAIM (ID: 21122)
            trigger50xAd: () => {
                if (window.Adsgram) {
                    RewardController.show().then(() => {
                        applySessionGains();
                        refillBalls(50);
                    }).catch(() => {
                        applySessionGains();
                        refillBalls(50);
                    });
                } else {
                    applySessionGains();
                    refillBalls(50);
                }
            },

            // BANNER TIKLAMA FONKSƒ∞YONU (ID: 21121)
            showBannerAd: () => {
                if(window.Adsgram) {
                    BannerController.show().catch((e) => {
                        console.log("Banner error:", e);
                    });
                }
            }
        };

        function applySessionGains() {
            COINS.forEach(c => { if(sessionGains[c.id]) { c.currentBalance += sessionGains[c.id]; } });
            modal.style.display = 'none';
        }

        function renderWithdrawList() {
            withdrawList.innerHTML = '';
            COINS.forEach(c => {
                const p = Math.min((c.currentBalance / c.minWithdraw) * 100, 100);
                const r = c.currentBalance >= c.minWithdraw;
                withdrawList.innerHTML += `
                    <div class="coin-withdraw-row">
                        <div class="cw-top"><div class="cw-name"><img src="${c.src}" width="16"> ${c.id.toUpperCase()}</div><div class="cw-bal">${c.currentBalance.toFixed(c.decimals)}</div></div>
                        <div class="progress-track"><div class="progress-bar" style="width:${p}%"></div></div>
                        <input class="wallet-input" id="addr-${c.id}" placeholder="${r?'Address':'Min: '+c.minWithdraw}" ${r?'':'disabled'}>
                        <button class="w-btn ${r?'active':''}" onclick="window.game.requestWithdraw('${c.id}')" ${r?'':'disabled'}>${r?'WITHDRAW':'LOW BALANCE'}</button>
                    </div>`;
            });
        }

        // --- PHYSICS ENGINE ---
        let loadedCount = 0;
        function preload() {
            const savedTime = localStorage.getItem('nextFreeClaim');
            if(savedTime) nextFreeClaimTime = parseInt(savedTime);

            loadUserData().then(() => {
                COINS.forEach(c => {
                    const img = new Image(); img.src = c.src;
                    img.onload = () => { c.img = img; document.getElementById('icon-'+c.id).src=c.src; loadedCount++; if(loadedCount===COINS.length) { dropBtn.innerText="DROP"; init(); } };
                });
            });
        }

        function init() { resize(); window.addEventListener('resize', resize); dropBtn.addEventListener('mousedown', tryDropBall); dropBtn.addEventListener('touchstart', (e)=>{e.preventDefault();tryDropBall()}); refillBalls(5); loop(); }
        
        function refillBalls(count) {
            ballQueue = []; sessionGains = {};
            for(let i=0; i<count; i++) {
                ballQueue.push(COINS[Math.floor(Math.random() * COINS.length)]);
            }
            ballsLeftEl.innerText = ballQueue.length;
            dropBtn.disabled = false;
            modal.style.display = 'none';
            sessionPanel.classList.remove('visible');
        }

        function resize() { width = window.innerWidth; height = canvas.clientHeight; canvas.width = width; canvas.height = height; createBoard(); }
        
        function createBoard() {
            pegs = []; slots = [];
            const playableH = height; 
            let spV = (playableH * 0.85) / (ROWS + 2);
            let spH = (width * 0.95) / (ROWS + 1);
            const spacing = Math.min(spV, spH);
            const pegR = spacing * 0.11; window.ballR = spacing * 0.22;
            const startY = playableH * 0.15;
            
            for(let r=2; r<ROWS; r++) {
                for(let c=0; c<=r; c++) {
                    const x = (width/2) - (r*spacing/2) + (c*spacing);
                    const y = startY + r*spacing;
                    pegs.push({x,y,r:pegR, pulse:0});
                }
            }
            
            const slotY = startY + (ROWS-1)*spacing;
            const startX = (width/2) - (ROWS*spacing/2);
            const slotW = spacing - 4;
            const slotH = playableH - slotY;
            
            for(let i=0; i<ROWS+1; i++) {
                const x = startX + i*spacing - (spacing/2);
                let mIdx = Math.floor((i/(ROWS+1))*MULTIPLIERS.length);
                let val = MULTIPLIERS[mIdx] || 0.2;
                slots.push({x, y:slotY, w:slotW, h:slotH, val, color: val>=5?'#ef4444':(val>=1?'#8b5cf6':'#1f2937'), active:0});
            }
        }

        function tryDropBall() {
            const now = Date.now(); if(now - lastDropTime < 350) return; lastDropTime = now;
            if(ballQueue.length === 0) return;
            const coin = ballQueue.pop();
            ballsLeftEl.innerText = ballQueue.length;
            sessionPanel.classList.add('visible');
            balls.push({x: width/2 + (Math.random()-0.5)*4, y: 50, vx:(Math.random()-0.5)*1, vy:0, r:window.ballR, coin, dead:false});
            if(ballQueue.length===0) dropBtn.disabled = true;
        }

        function update() {
            let active = 0;
            balls.forEach(b => {
                if(!b.dead) {
                    active++;
                    b.vy += GRAVITY; b.vx *= FRICTION; b.x += b.vx; b.y += b.vy;
                    pegs.forEach(p => {
                        let dx = b.x - p.x; let dy = b.y - p.y; let dist = Math.hypot(dx,dy);
                        if(dist < p.r + b.r) {
                            let angle = Math.atan2(dy, dx);
                            let sp = Math.hypot(b.vx, b.vy) * BOUNCE; if(sp<1) sp=1;
                            b.vx = Math.cos(angle)*sp + (Math.random()-0.5)*0.2;
                            b.vy = Math.sin(angle)*sp;
                            b.x += Math.cos(angle)*(p.r+b.r-dist); b.y += Math.sin(angle)*(p.r+b.r-dist);
                            p.pulse = 5;
                        }
                    });
                    if(b.y > slots[0].y) {
                        for(let s of slots) {
                            if(b.x > s.x && b.x < s.x + s.w) {
                                b.dead = true;
                                const earn = b.coin.baseVal * s.val;
                                if(!sessionGains[b.coin.id]) sessionGains[b.coin.id] = 0; sessionGains[b.coin.id] += earn;
                                s.active = 10;
                                popups.push({txt:`+${earn.toFixed(b.coin.decimals)}`, x:b.x, y:b.y-20, c:b.coin.color, life:1});
                                break;
                            }
                        }
                        if(b.y > height) b.dead = true;
                    }
                }
            });
            
            if(ballQueue.length === 0 && active === 0 && balls.length > 0) setTimeout(showSummary, 800);
            balls = balls.filter(b => !b.dead);
            pegs.forEach(p => { if(p.pulse>0) p.pulse--; });
            slots.forEach(s => { if(s.active>0) s.active--; });
            for(let i=popups.length-1; i>=0; i--) { popups[i].y-=0.5; popups[i].life-=0.02; if(popups[i].life<=0) popups.splice(i,1); }
        }

        function showSummary() {
            let html = '';
            COINS.forEach(c => {
                const g = sessionGains[c.id] || 0;
                if(g>0) html += `<div class="summary-row" style="display:flex;justify-content:space-between;border-bottom:1px solid #333;padding:5px;font-size:12px"><span>${c.id.toUpperCase()}</span><span style="color:#4ade80">+${g.toFixed(c.decimals)}</span></div>`;
            });
            roundSummaryEl.innerHTML = html || '<div style="color:#666">No earnings</div>';
            modal.style.display = 'flex';
        }

        function draw() {
            ctx.clearRect(0,0,width,height);
            slots.forEach(s => {
                ctx.fillStyle = s.active>0 ? '#fff' : s.color;
                ctx.globalAlpha = 0.3; ctx.fillRect(s.x, s.y, s.w, s.h);
                ctx.globalAlpha = 1; ctx.fillRect(s.x, s.y, s.w, 4);
                ctx.fillStyle = '#fff'; ctx.font='bold 10px Arial'; ctx.textAlign='center'; ctx.fillText(s.val+'x', s.x+s.w/2, s.y+20);
            });
            pegs.forEach(p => {
                ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                ctx.fillStyle = p.pulse>0 ? '#fff' : '#334155'; ctx.fill();
            });
            balls.forEach(b => {
                ctx.save(); ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.clip();
                ctx.drawImage(b.coin.img, b.x-b.r, b.y-b.r, b.r*2, b.r*2); ctx.restore();
            });
            popups.forEach(p => {
                ctx.globalAlpha = p.life; ctx.fillStyle = p.c; ctx.font='bold 12px monospace'; ctx.textAlign='center';
                ctx.fillText(p.txt, p.x, p.y); ctx.globalAlpha = 1;
            });
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }
        preload();
    </script>
</body>
</html>
